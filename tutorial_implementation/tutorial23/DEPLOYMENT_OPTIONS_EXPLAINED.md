# Deployment Options Explained: ADK vs Custom FastAPI

**Last Updated**: October 17, 2025  
**Based On**: Official ADK Documentation + Source Code Analysis

---

## TL;DR: Do You Need a Custom FastAPI Server?

| Question | Answer | Use Path |
|----------|--------|----------|
| **Want to deploy ASAP?** | ✅ No custom server needed | `adk deploy cloud_run/gke` |
| **Need custom authentication?** | ❌ Yes, custom server required | Tutorial 23 (this repo) |
| **Need advanced logging/monitoring?** | ❌ Yes, custom server required | Tutorial 23 (this repo) |
| **Need specific business logic endpoints?** | ❌ Yes, custom server required | Tutorial 23 (this repo) |
| **Just prototyping?** | ✅ ADK's built-in is fine | `adk deploy cloud_run/gke` |
| **Production with compliance needs?** | ❌ Yes, custom server recommended | Tutorial 23 (this repo) |

---

## How ADK's Built-In Server Works (What Happens Under the Hood)

When you run `adk deploy cloud_run`, `adk deploy gke`, or `adk deploy agent_engine`, here's what ADK does automatically:

### 1. **Code Generation Phase**

ADK auto-generates several files in a temporary folder:

```
temp_folder/
├── Dockerfile              # Container definition
├── main.py                 # FastAPI application
└── agents/
    └── your_agent_code/
```

### 2. **The Dockerfile (Auto-Generated)**

```dockerfile
FROM python:3.11-slim
WORKDIR /app

# Create non-root user
RUN adduser --disabled-password --gecos "" myuser

# Copy files
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .

# Run FastAPI server using uvicorn
USER myuser
CMD ["sh", "-c", "uvicorn main:app --host 0.0.0.0 --port $PORT"]
```

**Key point**: ADK uses `uvicorn` to serve a FastAPI application

### 3. **The main.py (Auto-Generated)**

```python
# Auto-generated by ADK
from google.adk.cli.fast_api import get_fast_api_app

# ADK's built-in function creates the FastAPI app
app = get_fast_api_app(
    agents_dir="/app/agents",
    session_service_uri=SESSION_SERVICE_URI,
    allow_origins=ALLOWED_ORIGINS,
    web=SERVE_WEB_INTERFACE,
)

# Uvicorn runs it
if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8080)
```

### 4. **What's Inside `get_fast_api_app()`?**

The `get_fast_api_app()` function from `google.adk.cli.fast_api` creates a FastAPI application with:

**✅ Included Endpoints:**
- `GET /` - API info
- `GET /health` - Basic health status
- `GET /agents` - List available agents
- `POST /invoke` - Run an agent
- `GET /docs` - Auto-generated API documentation
- `GET /sessions` - Session management

**❌ NOT Included:**
- ❌ Custom authentication (no Bearer tokens, API keys, etc.)
- ❌ Advanced monitoring (no request IDs, custom metrics)
- ❌ Custom business logic endpoints
- ❌ Structured logging patterns
- ❌ Advanced error handling
- ❌ Rate limiting
- ❌ Circuit breakers
- ❌ Custom health check logic

### 5. **Deployment Process**

```
YOUR AGENT CODE
      ↓
adk deploy cloud_run/gke
      ↓
[ADK Auto-Generates]
├── Dockerfile (shown above)
├── main.py (with get_fast_api_app())
└── requirements.txt
      ↓
[Container Built]
      ↓
[Deployed to Platform]
      ↓
Live FastAPI Server
(using ADK's built-in get_fast_api_app)
```

---

## Path 1: Simple Deployment (ADK's Built-In Server)

### When to Use This Path

✅ **Perfect for:**
- Quick prototyping
- Internal tools
- Non-production deployments
- Learning ADK
- Testing agents
- MVP development

❌ **NOT suitable for:**
- Production with compliance requirements
- Custom security needs
- Specific monitoring requirements
- Custom business logic

### How to Use It

```bash
# Cloud Run (recommended for most)
adk deploy cloud_run \
  --project your-project-id \
  --region us-central1

# GKE (if you have Kubernetes)
adk deploy gke \
  --project your-project-id \
  --cluster_name your-cluster \
  --region us-central1

# Agent Engine (managed infrastructure)
adk deploy agent_engine \
  --project your-project-id \
  --region us-central1
```

### What You Get

```
🎯 Your Agent Code
├── ✅ Automatic Container Build
├── ✅ FastAPI Server (get_fast_api_app)
├── ✅ Basic Health Endpoint
├── ✅ Session Management
├── ✅ Auto-Scaling
└── ✅ Public HTTPS URL
```

### Endpoints Available

```bash
# List all agents
curl https://your-service-url/agents

# Invoke an agent
curl -X POST https://your-service-url/invoke \
  -H "Content-Type: application/json" \
  -d '{"agent_name": "my_agent", "input": "Hello!"}'

# Health check
curl https://your-service-url/health

# API documentation
curl https://your-service-url/docs
```

---

## Path 2: Custom Deployment (Your Own FastAPI Server)

### When to Use This Path

✅ **Necessary for:**
- Production deployments
- Custom authentication requirements
- Advanced monitoring/observability
- Custom business logic
- Compliance/security standards
- Specific performance requirements
- Custom logging patterns
- Rate limiting or circuit breakers

❌ **More work, but necessary when:**
- You need full control over the API
- You have specific requirements not in ADK's defaults
- You're building production systems

### How to Use It

Create your own `main.py`:

```python
from fastapi import FastAPI
from google.adk.cli.fast_api import get_fast_api_app
# OR implement custom server (like Tutorial 23)

# Option A: Extend ADK's built-in
app = get_fast_api_app(
    agents_dir="./agents",
    # Add custom middleware, routes, etc.
)

# Option B: Custom implementation (Tutorial 23 approach)
from your_custom_server import app
```

### Tutorial 23: Custom Production Server

The server in this repository (`tutorial23/production_agent/server.py`) demonstrates:

**✅ Configuration Management**
```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    model_config = SettingsConfigDict(env_file=".env")
    
    GOOGLE_CLOUD_PROJECT: str
    API_KEY: str
    REQUEST_TIMEOUT: int = 30
```

**✅ Authentication**
```python
def verify_api_key(token: str) -> bool:
    """Validate Bearer token"""
    return token == settings.API_KEY
```

**✅ Health Checks with Metrics**
```python
@app.get("/health")
async def health():
    return {
        "status": "healthy",
        "request_count": metrics["request_count"],
        "error_rate": metrics["error_rate"],
    }
```

**✅ Structured Logging**
```python
logger = logging.getLogger("my_agent")
logger.info("invoke_agent.started", extra={
    "request_id": request_id,
    "agent": agent_name,
})
```

**✅ Timeout Protection**
```python
async def invoke_agent(request: QueryRequest):
    try:
        async with asyncio.timeout(settings.REQUEST_TIMEOUT):
            result = await runner.async_invoke(...)
    except asyncio.TimeoutError:
        return {"error": "Agent execution timeout"}
```

---

## Deployment Strategy Comparison

```
┌─────────────────────┬──────────────────┬──────────────────┐
│ Aspect              │ ADK Built-In     │ Custom Server    │
├─────────────────────┼──────────────────┼──────────────────┤
│ Setup Time          │ < 1 minute       │ 30+ minutes      │
│ Authentication      │ None             │ Full control     │
│ Logging             │ Basic            │ Advanced         │
│ Monitoring          │ Basic            │ Full control     │
│ Error Handling      │ Basic            │ Advanced         │
│ Rate Limiting       │ No               │ Yes              │
│ Custom Endpoints    │ Limited          │ Unlimited        │
│ Maintenance         │ ADK maintains    │ You maintain     │
│ Best For            │ Prototyping      │ Production       │
│ Code Size           │ ~50 lines        │ ~500 lines       │
│ Learning Curve      │ Easy             │ Medium           │
└─────────────────────┴──────────────────┴──────────────────┘
```

---

## Decision Tree: Which Path Should I Choose?

```
Start: I want to deploy an ADK agent
            |
            ├─ Is this for learning/prototyping?
            │  ├─ YES → Use Path 1 (adk deploy)
            │  └─ NO → Continue
            │
            ├─ Do I need custom authentication?
            │  ├─ YES → Use Path 2 (Custom Server)
            │  └─ NO → Continue
            │
            ├─ Do I need advanced monitoring?
            │  ├─ YES → Use Path 2 (Custom Server)
            │  └─ NO → Continue
            │
            ├─ Is this production workload?
            │  ├─ YES → Use Path 2 (Custom Server)
            │  └─ NO → Use Path 1 (adk deploy)
            │
            ├─ Do I have specific compliance needs?
            │  ├─ YES → Use Path 2 (Custom Server)
            │  └─ NO → Use Path 1 (adk deploy)
            │
            └─ DEFAULT → Use Path 1 (adk deploy)
```

---

## GKE Specific: Two Options

### Option 1: Automated (`adk deploy gke`)

**What ADK Does:**
1. Builds Docker image
2. Pushes to Artifact Registry
3. Generates Kubernetes manifests
4. Deploys to GKE cluster
5. Creates LoadBalancer service

```bash
adk deploy gke \
  --project my-project \
  --cluster_name my-cluster \
  --region us-central1 \
  ./my_agent
```

**Result:** Your agent running on GKE with auto-generated `main.py` using `get_fast_api_app()`

### Option 2: Manual with kubectl

**What You Do:**
1. Create your own `main.py`
2. Create `Dockerfile`
3. Build image: `gcloud builds submit`
4. Create `deployment.yaml`
5. Deploy: `kubectl apply -f deployment.yaml`

**Advantage:** Full control over `main.py` - can use custom server

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-agent
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: my-agent
        image: gcr.io/my-project/my-agent:latest
        ports:
        - containerPort: 8080
        env:
        - name: PORT
          value: "8080"
```

---

## Under the Hood: How ADK Serves Agents

### The Request Flow (With ADK's Built-In Server)

```
Client Request
       ↓
GET /invoke?agent=my_agent&input=hello
       ↓
[FastAPI Route Handler - get_fast_api_app()]
       ↓
[Create InMemorySessionService]
       ↓
[Create Runner from ADK]
       ↓
runner.async_invoke(agent=my_agent, input=hello)
       ↓
[Execute Agent Code]
       ↓
[Collect Events/Output]
       ↓
[Format Response as JSON]
       ↓
HTTP Response with Result
```

### Key ADK Classes Involved

```python
# from google.adk.cli.fast_api
get_fast_api_app()  # Creates FastAPI with all endpoints

# from google.adk.runners
Runner  # Executes agents

# from google.adk.sessions
InMemorySessionService  # Manages conversation state

# from google.adk.agents
Agent  # Your agent definition
```

---

## Production Checklist

### If Using Path 1 (ADK Built-In)

- [ ] Test the `/health` endpoint
- [ ] Set environment variables properly
- [ ] Enable Cloud Logging
- [ ] Configure auto-scaling
- [ ] Set up Cloud Monitoring alerts
- [ ] Document API endpoints
- [ ] Test with production load
- [ ] Plan disaster recovery

### If Using Path 2 (Custom Server - Tutorial 23)

- [ ] All of Path 1 above, PLUS:
- [ ] Configure authentication
- [ ] Set up custom logging
- [ ] Implement rate limiting
- [ ] Configure CORS properly
- [ ] Document authentication scheme
- [ ] Test error scenarios
- [ ] Load test timeouts
- [ ] Monitor custom metrics
- [ ] Review security model
- [ ] Plan API versioning

---

## Real-World Examples

### Example 1: Startup MVP
**Requirement:** "Get our AI agent live this week"  
**Solution:** Path 1 (ADK built-in)
```bash
adk deploy cloud_run --project startup-proj --region us-central1 ./agent
# Done in 5 minutes!
```

### Example 2: Enterprise Production
**Requirements:** 
- Custom authentication (OAuth2)
- Custom logging to Cloud Logging
- Request tracing
- Rate limiting per customer
- Advanced monitoring

**Solution:** Path 2 (Custom server)
```python
# Custom server with all these features (like Tutorial 23)
# Deploy same way but with your own main.py
```

### Example 3: Kubernetes Multi-Agent System
**Requirements:**
- Run 3 related agents on GKE
- Share session state
- Custom service mesh
- Advanced networking

**Solution:** Path 2 (Custom server) + Manual GKE deployment
```bash
# Build custom Docker image with your main.py
gcloud builds submit --tag gcr.io/.../my-agent
# Deploy with kubectl and custom manifests
```

---

## Frequently Asked Questions

### Q: Can I use `get_fast_api_app()` and then add my own custom routes?

**A:** Yes! You can get ADK's app and then add your routes:
```python
app = get_fast_api_app(agents_dir="./agents")

# Add your custom endpoint
@app.get("/custom")
async def custom_endpoint():
    return {"custom": "data"}
```

### Q: If I use `adk deploy`, can I modify the generated main.py?

**A:** No, ADK re-generates it. For modifications, use manual deployment with your own `main.py`.

### Q: What authentication does `get_fast_api_app()` provide?

**A:** None by default. You must implement it yourself (see Tutorial 23).

### Q: Should I always use a custom server for production?

**A:** Not necessarily. For simple internal tools, ADK's built-in is fine. For customer-facing APIs with specific requirements, use custom server.

### Q: Can I deploy the custom server from Tutorial 23 using `adk deploy`?

**A:** Not directly. You need manual deployment (gcloud or kubectl).

### Q: What's the performance difference?

**A:** Negligible. Both use uvicorn + FastAPI. Custom server adds small overhead for authentication/logging.

### Q: Can I mix Path 1 and Path 2?

**A:** Yes, you can use `adk deploy` to learn, then switch to custom server for production.

---

## Summary

| | **Path 1: ADK Built-In** | **Path 2: Custom Server** |
|---|---|---|
| **Implementation** | `adk deploy cloud_run` | Custom `main.py` + deploy |
| **Setup Time** | 5 minutes | 2-4 hours |
| **Authentication** | None | Full control |
| **Logging** | Basic | Advanced |
| **Best For** | Prototyping | Production |
| **When to Use** | Learning, MVP | Real apps, compliance |
| **Tutorial** | Official ADK docs | **Tutorial 23** |

---

## Next Steps

1. **Want to deploy quickly?** → Use `adk deploy cloud_run`
2. **Want production patterns?** → Study `tutorial23/production_agent/server.py`
3. **Want both options?** → Deploy with `adk deploy` first, then refactor to custom server
4. **Have questions?** → Check `FASTAPI_BEST_PRACTICES.md` in this directory

---

**Sources:**
- [Official ADK Documentation](https://google.github.io/adk-docs/)
- [ADK Python GitHub](https://github.com/google/adk-python)
- [Google Cloud Run Docs](https://cloud.google.com/run/docs)
- [GKE Deployment Docs](https://google.github.io/adk-docs/deploy/gke/)
