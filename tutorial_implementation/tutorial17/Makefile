# Tutorial 17: Agent-to-Agent Communication - Official ADK Implementation
# Makefile for setup, development, testing, and demo
# Updated to use official Google ADK patterns and adk api_server commands

.PHONY: help setup dev test demo clean lint format start-agents stop-agents check-agents

# Default target
help:
	@printf "\nğŸš€ Tutorial 17: Agent-to-Agent Communication (Official ADK)\n\n"
	@printf "Available commands:\n"
	@printf "  %-15s %s\n" "setup" "Install dependencies and setup environment"
	@printf "  %-15s %s\n" "start-agents" "Start all remote A2A agents (official ADK)"
	@printf "  %-15s %s\n" "stop-agents" "Stop all running agents (clean)"
	@printf "  %-15s %s\n" "check-agents" "Check agent status and availability"
	@printf "  %-15s %s\n" "dev" "Start ADK web interface"
	@printf "  %-15s %s\n" "test" "Run all tests"
	@printf "  %-15s %s\n" "demo" "Show tutorial overview and examples"
	@printf "  %-15s %s\n" "clean" "Clean cache files and artifacts"
	@printf "  %-15s %s\n" "lint" "Run linting checks"
	@printf "  %-15s %s\n" "format" "Format code with black and isort"
	@printf "\n"

# Setup environment
setup:
	@printf "ğŸ“¦ Setting up Tutorial 17 environment...\n"
	@pip install -r requirements.txt || { printf "âŒ Failed to install requirements\n"; exit 1; }
	@pip install -e . || { printf "âŒ Failed to install main package\n"; exit 1; }
	@printf "âœ… Setup complete!\n"
	@printf "ğŸ“‹ Google ADK Version: $(shell pip show google-adk | grep Version | cut -d' ' -f2)\n"
	@printf "ğŸ’¡ Copy a2a_orchestrator/.env.example to .env and add your API keys.\n"

# Development mode - start ADK web interface
dev:
	@printf "ğŸŒ Starting ADK web interface...\n"
	@printf "   Open: http://localhost:8000\n"
	@printf "   Select: 'a2a_orchestrator' from agent dropdown\n\n"
	@adk web

# Run tests
test:
	@printf "ğŸ§ª Running tests...\n"
	@pytest tests/ -v --tb=short

# Demo - show example usage
demo:
	@printf "\nğŸ¯ Tutorial 17: Agent-to-Agent Communication (Official ADK)\n\n"
	@printf "This tutorial demonstrates distributed agent orchestration using official Google ADK.\n\n"
	@printf "ğŸ”§ Key Features:\n"
	@printf "  â€¢ Official RemoteA2aAgent for A2A communication\n"
	@printf "  â€¢ Agent discovery via .well-known/agent-card.json\n"
	@printf "  â€¢ Sub-agent pattern with automatic delegation\n"
	@printf "  â€¢ Three specialized remote agents with official ADK patterns\n\n"
	@printf "ğŸ¤– Remote Agents:\n"
	@printf "  ğŸ“š Research: http://localhost:8001 (web search, fact-checking)\n"
	@printf "  ğŸ“Š Analysis: http://localhost:8002 (data analysis, insights)\n"
	@printf "  âœï¸  Content:  http://localhost:8003 (content creation, formatting)\n\n"
	@printf "ğŸ’¡ Example Queries:\n"
	@printf "  â€¢ 'Research quantum computing developments and create summary'\n"
	@printf "  â€¢ 'Analyze electric vehicle market trends'\n"
	@printf "  â€¢ 'Create technical documentation for our AI platform'\n\n"
	@printf "ğŸš€ Quick Start:\n"
	@printf "  1. make setup\n"
	@printf "  2. Copy .env.example to .env + add GOOGLE_API_KEY\n"
	@printf "  3. make start-agents  (starts official ADK A2A servers)\n"
	@printf "  4. make check-agents  (verify communication works)\n"
	@printf "  5. make dev          (start ADK web interface)\n\n"
	@printf "ğŸ”§ Management Commands:\n"
	@printf "  â€¢ make check-agents  (verify all agents are running)\n"
	@printf "  â€¢ make stop-agents   (clean shutdown)\n"
	@printf "  â€¢ ./start_a2a_servers.sh  (direct script usage)\n"
	@printf "  â€¢ ./stop_a2a_servers.sh   (direct cleanup)\n\n"
	@printf "âœ¨ Official ADK Implementation:\n"
	@printf "  â€¢ Uses RemoteA2aAgent class from google.adk.agents\n"
	@printf "  â€¢ Official to_a2a() function for exposing agents\n"
	@printf "  â€¢ Auto-generated .well-known/agent-card.json\n"
	@printf "  â€¢ uvicorn + to_a2a() pattern for A2A servers\n\n"

# Clean up
clean:
	@printf "ğŸ§¹ Cleaning up...\n"
	@find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@find . -type f -name "*.pyo" -delete 2>/dev/null || true
	@find . -type f -name ".coverage" -delete 2>/dev/null || true
	@find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name ".adk_cache" -exec rm -rf {} + 2>/dev/null || true
	@rm -f .agent_pids 2>/dev/null || true
	@printf "âœ… Cleanup complete.\n"

# Linting
lint:
	@printf "ğŸ” Running linting checks...\n"
	@flake8 a2a_orchestrator tests --max-line-length=100 || { printf "âŒ Linting failed\n"; exit 1; }
	@printf "âœ… Linting checks passed (formatting may need attention).\n"

# Code formatting
format:
	@printf "ğŸ¨ Formatting code...\n"
	@isort a2a_orchestrator tests || { printf "âŒ Import sorting failed\n"; exit 1; }
	@black a2a_orchestrator tests || { printf "âŒ Black formatting failed\n"; exit 1; }
	@printf "âœ… Code formatting complete.\n"

# Start remote A2A agents using official ADK command
start-agents:
	@printf "ğŸš€ Starting remote A2A agents with official ADK servers...\n"
	@./start_a2a_servers.sh

# Stop remote agents using official ADK cleanup
stop-agents:
	@printf "ğŸ›‘ Stopping remote A2A agents with clean shutdown...\n"
	@./stop_a2a_servers.sh

# Check agent status and availability
check-agents:
	@printf "ğŸ” Checking A2A agent status...\n\n"
	@printf " Research Agent (8001): "
	@curl -s http://localhost:8001/.well-known/agent-card.json | jq -r '.name' 2>/dev/null || printf "âŒ Not responding\n"
	@printf "ğŸ“Š Analysis Agent (8002): "
	@curl -s http://localhost:8002/.well-known/agent-card.json | jq -r '.name' 2>/dev/null || printf "âŒ Not responding\n"
	@printf "âœï¸  Content Agent (8003):  "
	@curl -s http://localhost:8003/.well-known/agent-card.json | jq -r '.name' 2>/dev/null || printf "âŒ Not responding\n"
	@printf "\nğŸ’¡ If agents are not responding, run 'make start-agents'\n"