# Tutorial 15: Live API and Audio - Real-Time Voice Interactions
# Makefile for development, testing, and voice assistant demos

.PHONY: help setup dev test demo clean
.PHONY: basic_demo advanced_demo multi_demo interactive_demo all_demos
.PHONY: lint format validate

# Default target - show help
help:
	@echo "ğŸ™ï¸  Tutorial 15: Live API and Audio - Real-Time Voice Interactions"
	@echo ""
	@echo "ğŸ“‹ QUICK START:"
	@echo "  make setup    # Install dependencies"
	@echo "  make demo     # Run text-based demo (API key or Vertex AI)"
	@echo "  make basic_demo # Live API streaming demo (requires Vertex AI)"
	@echo ""
	@echo "ğŸ¯ DEVELOPMENT COMMANDS:"
	@echo "  make setup    # Install dependencies and package"
	@echo "  make dev      # Start ADK web interface (requires GOOGLE_API_KEY)"
	@echo "  make test     # Run comprehensive test suite"
	@echo ""
	@echo "ğŸª DEMO COMMANDS:"
	@echo "  make demo           # Text-based conversation demo (no mic needed)"
	@echo "  make basic_demo     # Basic Live API streaming example (Vertex AI)"
	@echo "  make advanced_demo  # Advanced features (proactivity, affective dialog)"
	@echo "  make multi_demo     # Multi-agent voice coordination"
	@echo "  make interactive_demo # Interactive voice mode (requires microphone)"
	@echo "  make all_demos      # Run all demos sequentially"
	@echo ""
	@echo "ğŸ§¹ MAINTENANCE:"
	@echo "  make clean    # Remove cache files and artifacts"
	@echo "  make lint     # Check code quality"
	@echo "  make format   # Format code with black"
	@echo "  make validate # Run full validation suite"
	@echo ""
	@echo "ğŸ“– TUTORIAL: https://github.com/raphaelmansuy/adk_training/tree/main/tutorial_implementation/tutorial15"

# Setup environment
setup:
	@echo "ğŸ“¦ Setting up Tutorial 15 environment..."
	pip install -r requirements.txt
	pip install -e .
	@echo "âœ… Setup complete!"
	@echo "ğŸ’¡ Next steps:"
	@echo "   1. Copy .env.example to .env: cp .env.example .env"
	@echo "   2. For text demo (make demo): Add GOOGLE_API_KEY to .env"
	@echo "   3. For Live API (make basic_demo): Set GOOGLE_GENAI_USE_VERTEXAI=1 and GOOGLE_CLOUD_PROJECT"
	@echo "   4. Run 'make demo' for basic text conversation"
	@echo "   5. Run 'make basic_demo' for real-time streaming"
	@echo "   6. For voice features: pip install pyaudio (optional)"

# Start ADK web interface
dev:
	@echo "ğŸŒ Starting ADK web interface..."
	@echo "ğŸ”‘ Make sure you have GOOGLE_API_KEY set in your environment"
	@echo "ğŸ™ï¸  Select 'voice_assistant' from the agent dropdown"
	@echo "ğŸ“± Visit http://localhost:8000 in your browser"
	adk web

# Run tests
test:
	@echo "ğŸ§ª Running comprehensive test suite..."
	pytest tests/ -v --cov=voice_assistant --cov-report=term-missing
	@echo "âœ… All tests completed!"

# Main demo (text-based, no microphone required)
demo:
	@echo "ğŸ¬ Running main voice assistant demo..."
	@echo "ğŸ’¬ This demo shows text-based conversation (no microphone needed)"
	@echo "ğŸ¤– Uses VoiceAssistant class with send_text() method"
	@echo "ğŸ”‘ Checking authentication..."
	@if [ -n "$$GOOGLE_GENAI_USE_VERTEXAI" ]; then \
		echo "   âœ… Using Vertex AI (project: $$GOOGLE_CLOUD_PROJECT)"; \
		if [ -z "$$GOOGLE_CLOUD_PROJECT" ]; then \
			echo "   âš ï¸  GOOGLE_CLOUD_PROJECT not set - Vertex AI may fail"; \
		fi; \
	elif [ -n "$$GOOGLE_API_KEY" ] || [ -n "$$GEMINI_API_KEY" ]; then \
		echo "   âœ… Using API Key"; \
		echo "   âš ï¸  Live API may have limitations with API keys"; \
	else \
		echo "   âš ï¸  No authentication found - demo will likely fail"; \
		echo "   ğŸ’¡ Set GOOGLE_API_KEY or configure Vertex AI"; \
	fi
	@echo "ğŸ“ Sends pre-written messages and shows responses"
	@echo "ğŸš€ Starting demo script..."
	python -m voice_assistant.demo
	@echo "âœ… Demo script finished!"

# Individual demo commands
basic_demo:
	@echo "ğŸ¯ Running Basic Live API Demo..."
	@echo "   Demonstrates fundamental bidirectional streaming with LiveRequestQueue"
	@echo "   âš ï¸  Requires Vertex AI authentication (not API keys)"
	@echo "   ğŸ”„ Sends one message and shows real-time streaming response"
	@echo "   ğŸ¤ Configured for voice output (Puck voice) but shows text responses"
	@echo "   ğŸ“¡ Uses Live API for low-latency conversation"
	python -m voice_assistant.basic_demo
	@echo "âœ… Basic demo completed!"

advanced_demo:
	@echo "âš¡ Running Advanced Features Demo..."
	@echo "   Shows proactivity, affective dialog, and video streaming concepts"
	python -m voice_assistant.advanced
	@echo "âœ… Advanced demo completed!"

multi_demo:
	@echo "ğŸ‘¥ Running Multi-Agent Voice Demo..."
	@echo "   Demonstrates coordinated voice agents with sequential workflow"
	python -m voice_assistant.multi_agent
	@echo "âœ… Multi-agent demo completed!"

interactive_demo:
	@echo "ğŸ¤ Running Interactive Voice Demo..."
	@echo "âš ï¸  This requires a microphone and PyAudio!"
	@echo "ğŸ’¡ Install PyAudio: pip install pyaudio"
	@echo "   (May require system audio libraries on some platforms)"
	python -m voice_assistant.interactive
	@echo "âœ… Interactive demo completed!"

# Run all demos sequentially
all_demos:
	@echo "ğŸª Running ALL voice assistant demos..."
	@echo "=========================================="
	$(MAKE) demo
	@echo ""
	$(MAKE) basic_demo
	@echo ""
	$(MAKE) advanced_demo
	@echo ""
	$(MAKE) multi_demo
	@echo ""
	@echo "ğŸ‰ All demos completed!"
	@echo "ğŸ’¡ For voice interaction: make interactive_demo (requires microphone)"
	@echo "ğŸ”§ Pro tip: Run individual demos with 'make <demo_name>'"

# Code quality
lint:
	@echo "ğŸ” Running code quality checks..."
	@command -v ruff >/dev/null 2>&1 && ruff check voice_assistant/ tests/ || echo "âš ï¸  ruff not installed (optional)"
	@command -v mypy >/dev/null 2>&1 && mypy voice_assistant/ || echo "âš ï¸  mypy not installed (optional)"
	@command -v flake8 >/dev/null 2>&1 && flake8 voice_assistant/ tests/ || echo "âš ï¸  flake8 not installed (optional)"
	@echo "âœ… Lint checks complete!"

format:
	@echo "ğŸ¨ Formatting code..."
	@command -v black >/dev/null 2>&1 && black voice_assistant/ tests/ || echo "âš ï¸  black not installed (optional)"
	@echo "âœ… Code formatting complete!"

# Comprehensive validation
validate: lint test
	@echo "âœ… Full validation complete!"

# Clean up
clean:
	@echo "ğŸ§¹ Cleaning up cache files and artifacts..."
	find . -type d -name __pycache__ -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name "*.pyd" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	find . -type d -name ".pytest_cache" -exec rm -rf {} +
	find . -type d -name ".coverage" -exec rm -rf {} +
	find . -type f -name ".coverage" -delete
	find . -type f -name "coverage.xml" -delete
	@echo "âœ… Cleanup completed!"
