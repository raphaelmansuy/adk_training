# Tutorial 14: Streaming Agent with Server-Sent Events (SSE)
# Makefile for development, testing, and demo commands

.PHONY: setup dev test demo clean help
.PHONY: basic_demo modes_demo chat_demo advanced_demo aggregator_demo
.PHONY: fastapi_demo client_demo all_demos

# Default target - show help
help:
	@echo "ğŸš€ Tutorial 14: Streaming Agent with Server-Sent Events (SSE)"
	@echo ""
	@echo "ğŸ“‹ QUICK START:"
	@echo "  make setup    # Install dependencies"
	@echo "  make demo     # Run the main demo"
	@echo ""
	@echo "ğŸ¯ DEVELOPMENT COMMANDS:"
	@echo "  make setup    # Install dependencies and package"
	@echo "  make dev      # Start ADK web interface (requires GOOGLE_API_KEY)"
	@echo "  make test     # Run comprehensive test suite"
	@echo ""
	@echo "ğŸª DEMO COMMANDS:"
	@echo "  make demo           # Run main streaming demo"
	@echo "  make basic_demo     # Basic streaming implementation"
	@echo "  make modes_demo     # StreamingMode configurations"
	@echo "  make chat_demo      # Interactive chat application"
	@echo "  make advanced_demo  # Advanced streaming patterns"
	@echo "  make aggregator_demo # Response aggregation demo"
	@echo "  make fastapi_demo   # FastAPI SSE server info"
	@echo "  make client_demo    # SSE client demo info"
	@echo "  make all_demos      # Run all demos sequentially"
	@echo ""
	@echo "ğŸ§¹ MAINTENANCE:"
	@echo "  make clean    # Remove cache files and artifacts"
	@echo ""
	@echo "ğŸ“– TUTORIAL: https://github.com/raphaelmansuy/adk_training/tree/main/tutorial_implementation/tutorial14"

# Setup environment
setup:
	@echo "ğŸ“¦ Setting up Tutorial 14 environment..."
	pip install -r requirements.txt
	pip install -e .
	@echo "âœ… Setup complete!"
	@echo "ğŸ’¡ Next steps:"
	@echo "   1. Copy streaming_agent/.env.example to .env"
	@echo "   2. Add your GOOGLE_API_KEY to .env"
	@echo "   3. Run 'make demo' to see streaming in action!"

# Start ADK web interface
dev:
	@echo "ğŸŒ Starting ADK web interface..."
	@echo "ğŸ”‘ Make sure you have GOOGLE_API_KEY set in your environment"
	@echo "ğŸ“± Visit http://localhost:8000 in your browser"
	adk web streaming_agent

# Run tests
test:
	@echo "ğŸ§ª Running comprehensive test suite..."
	pytest tests/ -v --cov=streaming_agent --cov-report=term-missing
	@echo "âœ… All tests completed!"

# Main demo (basic streaming)
demo:
	@echo "ğŸ¬ Running main streaming demo..."
	python demos/basic_streaming_demo.py
	@echo "âœ… Demo completed!"

# Individual demo commands
basic_demo:
	@echo "ğŸ¯ Running Basic Streaming Demo..."
	@echo "   Demonstrates fundamental streaming with Runner.run_async()"
	python demos/basic_streaming_demo.py
	@echo "âœ… Basic demo completed!"

modes_demo:
	@echo "ğŸ”„ Running Streaming Modes Demo..."
	@echo "   Shows different StreamingMode configurations (SSE, NONE)"
	python demos/streaming_modes_demo.py
	@echo "âœ… Modes demo completed!"

chat_demo:
	@echo "ğŸ’¬ Running Streaming Chat Application..."
	@echo "   Interactive chat with real-time streaming responses"
	@echo "   Press Ctrl+C to exit"
	python demos/streaming_chat_app.py
	@echo "âœ… Chat demo completed!"

advanced_demo:
	@echo "âš¡ Running Advanced Streaming Patterns Demo..."
	@echo "   Demonstrates: aggregation, progress indicators, multiple outputs, timeout"
	python demos/advanced_patterns_demo.py
	@echo "âœ… Advanced demo completed!"

aggregator_demo:
	@echo "ğŸ“Š Running Streaming Aggregator Demo..."
	@echo "   Shows response aggregation and chunk analysis"
	python demos/streaming_aggregator_demo.py
	@echo "âœ… Aggregator demo completed!"

fastapi_demo:
	@echo "ğŸš€ FastAPI SSE Demo Setup Instructions"
	@echo "======================================"
	@echo "This demo shows how to build web APIs with streaming SSE."
	@echo ""
	@echo "ğŸ“¦ Install additional dependencies:"
	@echo "   pip install fastapi uvicorn"
	@echo ""
	@echo "ğŸš€ Start the FastAPI server:"
	@echo "   python -m uvicorn demos.fastapi_sse_demo:app --reload --host 0.0.0.0 --port 8000"
	@echo ""
	@echo "ğŸŒ Open in browser:"
	@echo "   http://localhost:8000/docs     - Interactive API documentation"
	@echo "   http://localhost:8000/client   - Built-in test client"
	@echo ""
	@echo "ğŸ§ª Test the streaming endpoint:"
	@echo "   curl \"http://localhost:8000/chat/stream?query=Hello%20world\""
	@echo ""
	@echo "ğŸ’¡ The server includes:"
	@echo "   â€¢ RESTful chat endpoints"
	@echo "   â€¢ Server-Sent Events streaming"
	@echo "   â€¢ Built-in HTML test client"
	@echo "   â€¢ CORS headers for web apps"

client_demo:
	@echo "ğŸŒ SSE Client Demo Setup Instructions"
	@echo "===================================="
	@echo "This demo shows client-side JavaScript for SSE connections."
	@echo ""
	@echo "ğŸ“‹ Requirements:"
	@echo "   â€¢ FastAPI server running (see 'make fastapi_demo')"
	@echo "   â€¢ Modern web browser"
	@echo ""
	@echo "ğŸš€ Start local web server:"
	@echo "   python -m http.server 8080"
	@echo ""
	@echo "ğŸŒ Open in browser:"
	@echo "   http://localhost:8080/demos/sse_client.html"
	@echo ""
	@echo "ğŸ’¡ Features:"
	@echo "   â€¢ Real-time SSE connection"
	@echo "   â€¢ Progressive message display"
	@echo "   â€¢ Error handling and reconnection"
	@echo "   â€¢ Clean, responsive UI"
	@echo "   â€¢ Typing indicators"

# Run all demos sequentially
all_demos:
	@echo "ğŸª Running ALL streaming demos..."
	@echo "=================================="
	$(MAKE) basic_demo
	@echo ""
	$(MAKE) modes_demo
	@echo ""
	$(MAKE) advanced_demo
	@echo ""
	$(MAKE) aggregator_demo
	@echo ""
	$(MAKE) fastapi_demo
	@echo ""
	$(MAKE) client_demo
	@echo ""
	@echo "ğŸ‰ All demos completed!"
	@echo "ğŸ’¡ Pro tip: Run individual demos with 'make <demo_name>'"

# Clean up
clean:
	@echo "ğŸ§¹ Cleaning up cache files and artifacts..."
	find . -type d -name __pycache__ -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type f -name "*.pyd" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	find . -type d -name ".pytest_cache" -exec rm -rf {} +
	find . -type d -name ".coverage" -exec rm -rf {} +
	find . -type f -name ".coverage" -delete
	find . -type f -name "coverage.xml" -delete
	find . -type f -name "streaming_output.txt" -delete
	@echo "âœ… Cleanup completed!"